An essential step for obtaining computational proofs of geometric results is \emph{discretization}: problems concerning the existence of an object $\mathcal{O}$ in a continuous space such as $\mathbb{R}^2$ must be reformulated in terms of the existence of a discrete and finitely representable object $\mathcal{O}'$ that a computer can find (or discard its existence).
This poses a particular challenge for problems in which the desired geometric object $\mathcal{O}$ is characterized by very specific coordinates of points, requiring to deal with floating point arithmetic or numerical instability.
Fortunately, this is not the case for Erd\H{o}s-Szekeres-type problems such as determining the value of $h(k)$, which are naturally well-suited for computation.
This is so because the properties of interest (e.g., convexity, emptiness) can be described in terms of high-level relationships between points and lines (e.g., point $p$ is above the line $\vec{qr}$, lines $\vec{qr}$ and $\vec{st}$ intersect, etc.), which are invariant under rotations, translations, and even small perturbations of the coordinates. This suggests the problems can be discretized in terms of boolean variables representing these high-level relationships, forgetting the specific coordinates of the points.
The combinatorial abstraction that has been most widely used in Erd\H{o}s-Szekeres-type problems is that of \emph{triple orientations}~\cite{ emptyHexagonNumber, scheucherTwoDisjoint5holes2020}.\footnote{Also known as \emph{signotopes}~\cite{felsnerSweepsArrangementsSignotopes2001,subercaseaux2023minimizing},  Knuth's \emph{counterclockwise} relation~\cite{knuthAxiomsHulls1992}, or \emph{signatures}~\cite{szekeres_peters_2006}.}
Given points $p, q, r$, their \emph{triple-orientation} is defined as
\newcommand{\sign}{\operatorname{sign}}
\[
  \sigma(p, q, r) = \sign \det \begin{pmatrix} p_x & q_x & r_x \\ p_y & q_y & r_y \\ 1 & 1 & 1 \end{pmatrix} = \begin{cases}
    1 & \text{if } p, q, r \text{ are \emph{oriented} counterclockwise}, \\
    0 & \text{if } p, q, r \text{ are collinear}, \\
    -1 & \text{if } p, q, r \text{ are \emph{oriented} clockwise}.
  \end{cases}.
\]

\begin{figure}
  \centering
\begin{tikzpicture}
  %\draw[ultra thick, dashed, blue] (5,1) -- (0,0);
  \node[draw, circle, black, fill=black, inner sep=0pt, minimum size=5pt] (p) at (0,0) {};
  \node[] at (-0.2, 0.25) {$p$};
  \node[draw, circle, black, fill=black, inner sep=0pt, minimum size=5pt] (q) at (5,1) {};
  \node[] at (5.2, 0.75) {$q$};
  \node[draw, circle, black, fill=black, inner sep=0pt, minimum size=5pt] (r) at (2,3) {};
  \node[] at (2, 3.25) {$r$};

  \node[draw, circle, black, fill=black, inner sep=0pt, minimum size=5pt] (s) at (1.5, 1) {};
  \node[] at (1.35, 1.2) {$s$};

  \node[draw, circle, black, fill=black, inner sep=0pt, minimum size=5pt] (t) at (4.5, 3) {};
  \node[] at (4.3, 3.25) {$t$};

  \draw[ thick,  green!60!black] (p) -- (r);
  \draw[ thick,  green!60!black, ->] (r) -- (q);

  \draw[ thick,  blue] (r) -- (s);
  \draw[ thick,  blue, ->] (s) -- (q);

  \draw[thick,  red] (p) -- (s);
  \draw[thick,  red, ->] (s) -- (t);
  % \draw[fill=green, opacity=0.5] (a.center) -- (b.center) -- (c.center) -- cycle;
\end{tikzpicture}
\caption{Illustration of triple orientations, where $\sigma(p, r, q) = -1, \sigma(r, s, q) = 1, $ and $\sigma(p, s, t) = 0$.}\label{fig:triple-orientation}
\end{figure}

An example is illustrated in~\Cref{fig:triple-orientation}. We directly use \textsf{mathlib}'s definition of the determinant to define $\sigma$.
% @[pp_dot] abbrev x (p : Point) : ℝ := p 0
% @[pp_dot] abbrev y (p : Point) : ℝ := p 1
\begin{lstlisting}
inductive Orientation : Type where
  | cw -- clockwise :=  -
  | ccw -- counter clockwise := +
  | collinear -- := 0

noncomputable def σ (p q r : Point) : Orientation :=
  let det := Matrix.det !![p.x, q.x, r.x ; p.y, q.y, r.y ; 1, 1, 1]
  if 0 < det then ccw
  else if det < 0 then cw
  else collinear
\end{lstlisting}

% def Orientation.ofReal (r : ℝ) : Orientation :=
%   if 0 < r then ccw
%   else if r < 0 then cw
%   else collinear

Through the $\sigma$ function we can immediately define the notion of \emph{general position} for collections (e.g., finite sets, lists, etc.) of points, simply establishing that $\sigma(p, q, r) \neq 0$ for every three distinct points $p, q, r$ in the collection.
Furthermore, we can start formalizing sets of points that are \emph{equivalent} with respect to their triple orientations, and consequently, properties of pointsets that are fully captured by their triple orientations~(\emph{orientation properties}).
% An illustration is presented in~\Cref{fig:sigma-equiv}.
% \input{fig-sigma-equiv.tex}
\begin{lstlisting}
structure σEquiv (S T : Set Point) where
  f : Point → Point
  bij : Set.BijOn f S T
  parity : Bool -- See Section 4 for a more detailed explanation
  σ_eq : ∀ (p ∈ S) (q ∈ S) (r ∈ S), σ p q r = parity ^^^ σ (f p) (f q) (f r)

def OrientationProperty (P : List Point → Prop) :=
  ∀ {{S T}}, S ≃σ T → (P S ↔ P T) -- `≃σ` is infix notation for `σEquiv`
\end{lstlisting}

To illustrate how these notions will be used, let us consider the property, corresponding to \lstinline|HasConvexEmptyKGon|.
\[
  \pi_k(S) \triangleq \text{\em ``pointset } S \text{ contains an empty convex } k\text{-gon''}.
\]

Based on \lstinline|ConvexEmptyIn.iff_triangles|, we know that $\pi_k(S)$ can be written in terms of triangles that are empty w.r.t $S$. We can define triangle emptiness using $\sigma$, and prove its equivalence to the geoemetric definition.
\begin{lstlisting}
/-- `PtInTriangle a p q r` means that `a` is in the triangle `pqr`,
possibly on the boundary. -/
def PtInTriangle (a : Point) (p q r : Point) : Prop :=
  a ∈ convexHull ℝ {p, q, r}

/-- `σPtInTriangle a p q r` means that `a` is in the triangle `pqr` strictly,
i.e., not on the boundary. -/
def σPtInTriangle (a p q r : Point) : Prop :=
  σ p q a = σ p q r ∧
  σ p a r = σ p q r ∧
  σ a q r = σ p q r

theorem σPtInTriangle_iff {a p q r : Point} (gp : InGeneralPosition₄ a p q r) :
  σPtInTriangle a p q r ↔ PtInTriangle a p q r
\end{lstlisting}

% def PtInTriangle (a p q r : Point) : Prop := a ∈ convexHull ℝ {p, q, r}

% def σPtInTriangle (a p q r : Point) : Prop :=
%   σ p q r = σ p a r ∧ σ p a q = σ p r q ∧ σ q a r = σ q p r

% theorem σPtInTriangle_iff {a p q r : Point} (gp : PtFinsetInGenPos {a,p,q,r}) :
%   σPtInTriangle a p q r ↔ PtInTriangle a p q r -- not trivial.

% def HasEmptyTriangle (pts : Set Point) : Prop := ∃ p q r, [p, q, r].Nodup
% ∧ {p,q,r} ⊆ pts ∧ ∀ a ∈ pts, a ∉ ({p, q, r} : Set Point) → ¬PtInTriangle a p q r

% theorem OrientationProperty_HasEmptyTriangle : OrientationProperty HasEmptyTriangle


% Let us now discuss the previous steps. First,~\lstinline|(PtInTriangle a p q r)| presents a \emph{ground-truth}  definition for membership in a triangle, in terms of~\textsf{mathlib}'s \lstinline|ConvexHull| definition,  whereas~\lstinline|(σPtInTriangle a p q r)| is based on orientations.
Heule and Scheucher used the orientation-based definition~\cite{emptyHexagonNumber}, and as it is common in the area, its equivalence to the \emph{ground-truth} mathematical definition was left implicit. This equivalence, proven in~\lstinline|theorem σPtInTriangle_iff| is not trivial to prove, in particular the forward direction requires reasoning about convex combinations and determinants.
Using the previous theorem, we can generalize to $k$-gons as follows.
\begin{lstlisting}
def σHasEmptyKGon (n : Nat) (S : Set Point) : Prop :=
  ∃ s : Finset Point, s.card = n ∧ ↑s ⊆ S ∧
    ∀ (a ∈ s) (b ∈ s) (c ∈ s), a ≠ b → a ≠ c → b ≠ c →
      σIsEmptyTriangleFor a b c S

theorem σHasEmptyKGon_iff_HasEmptyKGon (gp : PointListInGeneralPosition pts) :
      σHasEmptyKGon n pts.toFinset ↔ HasEmptyKGon n pts.toFinset
\end{lstlisting}

Then, because \lstinline|σHasEmptyKGon| is ultimately defined in terms of $\sigma$, we can prove
\begin{lstlisting}
lemma OrientationProperty_σHasEmptyKGon : OrientationProperty (σHasEmptyKGon n)
\end{lstlisting}
Which in combination with \lstinline|theorem σHasEmptyKGon_iff_HasEmptyKGon|, provides
\begin{lstlisting}
theorem OrientationProperty_HasEmptyKGon : OrientationProperty (HasEmptyKGon n)
\end{lstlisting}

Let us discuss why the previous theorem is relevant, as it plays an important role in the formalization of Erd\H{o}s-Szekeres-type problems. This boils down to two reasons:
\begin{enumerate}
  \item If we prove that the function $\sigma$ is invariant under a certain transformation of its arguments (e.g., rotations, translations, etc.) then we can directly conclude that any orientation property is invariant under the same transformation. This is a powerful tool for applying manipulations to pointsets that preserve the properties of interest, which will be key for symmetry breaking (see~\Cref{sec:symmetry-breaking}). For a concrete example, when a proof for an Erd\H{o}s-Szekeres-type result starts saying \emph{``we assume without loss of generality that points $p_1, \ldots, p_n$ are sorted from left to right''}, we can immediately formalize that this assumption indeed maintains generality for orientation properties, as sorting a list naturally induces a bijection.
  \item As introduced at the beginning of this section, SAT encodings for Erd\H{o}s-Szekeres-type problems are based on capturing properties like convexity or emptiness in terms of triple orientations, thus reducing a continuous search space to a discrete one. Because we have proved that $\pi_k(S)$ is an orientation property, then the values of $\sigma$ for all triples of points in $S$ is enough information to determine whether $\pi_k(S)$ or not.  Therefore, we have proved that given $n$ points it is enough to analyze the values of $\sigma$ over the points, a discrete space with at most $2^{n^3}$ possibilities, instead of $\left(\mathbb{R}^2\right)^n$. This is the key idea that will allow us to transition from the finitely-verifiable statement \emph{``no set of triple orientations over $n$ points satisfies property $\pi_k$''} to \emph{``no set of $n$ points satisfies property $\pi_k$''}.
\end{enumerate}


\subsection{Base variables}
% \subsection{Some key properties of the $\sigma$ function}
Ranging from the initial work of Peters and Szekeres~\cite{szekeres_peters_2006} to the recent work of Heule and Scheucher~\cite{emptyHexagonNumber}, the base variables are defined as follows. Assuming a list of points $L = (p_1, \ldots, p_n)$,
we construct boolean variables $\orvar_{a, b, c}$ that represent $\sigma(p, q, r) = 1$, provided $L[a] = p, L[b] = q, L[c] =r$.\footnote{Given that pointsets are assumed to be in general position we have $\neg \orvar_{i,j,k} \iff \sigma(p, q, r) = -1$.} If one were to create a variable $\orvar_{a,b,c}$ for every triple of points $p \neq q \neq r$, that would amount to $n(n-1)(n-2)$ variables for $n$ points. However, the orientations of triples $(p, q, r)$ and $(q, r, p)$ or $(r, q, p)$ contain redundant information: if $p,q,r$ are oriented counterclockwise, then $q,r,p$ and $r,p,q$ are also oriented counterclockwise, whereas $p,r,q$ is oriented clockwise. This is captured by the following two fundamental asymmetries:
\begin{lstlisting}
  lemma σ_perm₁ (p q r : Point) : σ p q r = -σ q p r
  lemma σ_perm₂ (p q r : Point) : σ p q r = -σ p r q
\end{lstlisting}
As a result, it suffices to have variables $\orvar(a, b, c)$ with $1 \leq a < b < c n$, thus reducing the number of variables by a factor of $3! = 6$.
Next, variables $\cvar_{i;a,b,c}$ correspond to whether point $i$ is inside the triangle $abc$, with $a < b < c$.
If we assume that points will be sorted from left to right (which will be justified in~\Cref{sec:symmetry-breaking}), then we only need to consider $a < i < c$,
and by combining the definition of \lstinline|σPtInTriangle| with the \lstinline|σ_perm| lemmas, we obtain precisely the definition of $\cvar_{i;a,b,c}$ of~\Cref{eq:insideClauses1,eq:insideClauses2}.
Finally, the variables $\hvar_{a, b, c}$ correspond to whether the triangle $abc$ is empty, and are defined in terms of $\cvar_{i;a,b,c}$ as in~\Cref{eq:holeDefClauses1}.






