Having established the reduction to orientations,
and the symmetry-breaking assumption of canonicity,
we now turn to the construction of a CNF formula $\phi_n$
whose unsatisfiability would imply
that every set of $n$ points
contains a $6$-hole.\footnote{
  Satisfiability of $\phi_n$ would \emph{not} necessarily imply
  the existence of a point set without a $6$-hole, due to the \emph{realizability problem} (see e.g.,~\cite{subercaseaux2023minimizing}).
  % First, the mapping from sets of points to assignments of triple orientations is not surjective.
  % Second, even if it were, $\phi_n$ is tailored to looking for an unsatisfiability proof,
  % using implication rather than bi-implication in some of the variable-defining clauses.
}
The formula is detailed in~\Cref{fig:full-encoding}.

\input{encoding-fig.tex}

\subparagraph*{Variables.}
Let $S = (p_1, \ldots, p_n)$ be the list of points in canonical position.
We explain the variables of $\phi_n$
by specifying their values in the propositional assignment $\tau_S$
that is our intended model of $\phi_n$
corresponding to $S$. We then have:
\begin{itemize}
  \item
    For every $2 \leq a < b < c \leq n$, $\orvar_{a,b,c}$ is true
    iff $\sigma(p_a,p_b,p_c) = +1$.\footnote{
    Since the point set is in general position,
    we have $\neg \orvar_{a,b,c} \iff \sigma(p_a, p_b, p_c) = -1$.}

    The first optimization observes that orientations are antisymmetric:
    if $(p,q,r)$ is counterclockwise then $(q,p,r)$ is clockwise, etc.
    Thus one only needs $\orvar_{a,b,c}$ for ordered triples $(a,b,c)$,
    reducing the number of orientation variables by a factor of $3! = 6$
    relative to using all triples. The second optimization uses the \textbf{CCW-order} property of canonical positions:
    since all $\orvar_{1,a,b}$ are true, we may as well omit them from the encoding.

  \item
    Next, for every $a < b < c$ with $a < i < b$ or $b < i < c$,
    the variable $\cvar_{i;a,b,c}$ is true
    iff \lstinline|σPtInTriangle S[i] S[a] S[b] S[c]| holds.
    By \lstinline|σPtInTriangle_iff|, this is true exactly
    iff $p_i$ is inside the triangle $p_ap_bp_c$.
    The reason for assuming $(a,b,c)$ to be ordered is again symmetry:
    $p_ap_bp_c$ is the same triangle as $p_ap_cp_b$, etc.
    Furthermore thanks to the \textbf{$x$-order} property of canonical positions,
    if $p_i$ is in the triangle
    then $x(p_a) < x(p_i) < x(p_c)$.
    This implies that $a < i < c$,
    leaving one case distinction permuting $(i,b)$.

  \item
    For every $a < b < c$,
    $\hvar_{a,b,c}$ is true
    iff \lstinline|σIsEmptyTriangleFor S[a] S[b] S[c] S| holds.
    %  Analogously to the previous items,
    By a geometro-combinatorial connection analogous to ones above,
    this is true iff $p_ap_bp_c$ is a $3$-hole.

  \item
    Finally, one defines \emph{$4$-cap}, \emph{$5$-cap}, and \emph{$4$-cup} variables.
    For $a+1 < c < d$, $\uvar_{a,c,d}$ is true
    iff there is $b$ with $a < b < c$ with $\sigma(p_a,p_b,p_c) = \sigma(p_b,p_c,p_d) = -1$.
    $\vvar_{a,c,d}$ is analogous, except in that the two orientations are required to be counterclockwise.
    These are the $4$-caps and $4$-cups, respectively.
    The $5$-cap variables $\ufvar_{a,d,e}$
    are defined for $a+2 < d < e$.
    We set $\ufvar_{a,d,e}$ to true
    iff there exists $c$ with $a+1<c<d$
    such that $\uvar_{a,c,d}$, $\orvar_{c,d,e}$, and $\hvar_{a,c,e}$ are all true.
    Intuitively, $4$-caps and $4$-cups are clockwise and counterclockwise arcs of length $4$,
    respectively,
    whereas $5$-caps are clockwise arcs of length $5$ containing a $3$-hole.
    All three are depicted in~\Cref{fig:cup-cap-vars}. The usage of these variables is crucial to an efficient encoding:
    we will show below that a hexagon can be covered by only $4$ triangles,
    so one need not consider all ${6\choose 3}$ triangles contained within it.
\end{itemize}

\input{fig-cup-cap.tex}

\subparagraph*{Satisfaction.}
We now have to justify that the clauses of $\phi_n$
are satisfied by the intended interpretation $\tau_S$
for a $6$-hole-free point set $S$.
The variable-defining clauses~\labelcref{eq:insideClauses1,eq:insideClauses2,eq:holeDefClauses1,eq:capDef,eq:cupDef,eq:capFDef,eq:capDef2,eq:cupDef2}
follow essentially by definition combined with boolean reasoning.
The orientation properties~\labelcref{eq:signotopeClauses11,eq:signotopeClauses12}
have been established in the family of theorems \lstinline|σ_propᵢ|.
The lexicographic ordering clauses~\labelcref{eq:revLexClauses}
follow from the \textbf{Lex order} property of canonical positions.
Thus we are left with clauses~\labelcref{eq:no6Hole1Below,eq:no6Hole4Above,eq:no6Hole2Below1,eq:no6Hole2Below2,eq:no6Hole3Below}
which forbid the presence of certain $6$-holes.\footnote{
They are intended to forbid \emph{all} $6$-holes,
but proving completeness is not necessary for an unsatisfiability-based result.}
We illustrate why clause~\labelcref{eq:no6Hole1Below} is true.
The contrapositive is easier to state:
if $\tau_S$ satisfies $\ufvar_{a,d,e}\wedge\orvar_{a,p,e}$,
then $S$ contains a $6$-hole.
The intuitive argument is depicted in~\Cref{fig:clause-13-forbid}.
The clause directly implies the existence of a convex hexagon $apedcb$
such that $ace$ is a $3$-hole.
It turns out that this is enough to ensure
the existence of a $6$-hole by ``flattening'' the triangles $ape$, $edc$, and $cba$,
if necessary,
to obtain empty triangles $ap'e$, $ed'c$, and $cb'a$,
which can be assembled into a $6$-hole $ap'ed'cb'$.

Justifying this formally turned out to be complex,
requring a fair bit of reasoning about point \lstinline|Arc|s
and \lstinline|σCCWPoints|: lists of points winding around a convex polygon.
Luckily, the main argument can be summarized in terms of two facts:
(a) any triangle $abc$ contains an empty triangle $ab'c$; and
(b) empty shapes sharing a common line segment can be glued together.
Formally, (a) can be stated as

\begin{lstlisting}
theorem σIsEmptyTriangleFor_exists (gp : ListInGenPos S)
  (abc : [a, b, c] ⊆ S) : ∃ b' ∈ S, σ a b' c = σ a b c
    ∧ (b' = b ∨ σPtInTriangle b' a b c) ∧ σIsEmptyTriangleFor a b' c S.toFinset
\end{lstlisting}
\begin{proof}
  Given points $p,q$, say that $p \leq q$ iff $p$ is in the triangle $aqc$.
  This is a preorder.
  Now, the set $S' = \{x \in S \mid \sigma(a,x,c) = \sigma(a,b,c) \wedge x \leq b\}$
  is finite and so has a weakly minimal element $b'$,
  in the sense that no $x \in S'$ has $x < b'$.
  Emptiness of $ab'c$ follows by minimality.
\end{proof}

Moving on, (b) follows from a \emph{triangulation lemma}:
given any convex point set $S$
and a line $\overleftrightarrow{ab}$ between two vertices of $S$,
the convex hull of $S$ is contained in the convex hulls
of points on either side of $\overleftrightarrow{ab}$.
That is:
\begin{lstlisting}
theorem split_convexHull (cvx : ConvexPoints S) :
  ∀ {a b}, a ∈ S → b ∈ S →
    convexHull ℝ S ⊆ convexHull ℝ {x ∈ S | σ a b x ≠ ccw}
                    ∪ convexHull ℝ {x ∈ S | σ a b x ≠ cw}
\end{lstlisting}
\input{fig_triangulation2.tex}
\begin{proof}
    Let $S^+=\{x\in S\mid \sigma(a,b,x)\ge 0\}$ and $S^-=\{x\in S\mid \sigma(a,b,x)\le 0\}$ be the two sets in the theorem, and let $p\in \overline{S}$, where $\overline{S}$ denotes the convex hull of $S$. Assume WLOG that $\sigma(a,b,p)\ge 0$. (We would like to show that $p\in \overline{S^+}$.) Now $p$ is a convex combination of elements of $S^+$ and elements of $S^-$, so there exist points $u\in \overline{S^-}$ and $v\in \overline{S^+}$ such that $p$ lies on the $\overline{uv}$ line.
%
    Because $\{x\mid \det(a,b,x)\le 0\}\supseteq S^-$ is convex, it follows that $\det(a,b,u)\le 0$, and likewise $\det(a,b,v)\ge 0$, so they lie on opposite sides of the $\overleftrightarrow{ab}$ line and hence $\overline{uv}$ intersects $\overleftrightarrow{ab}$ at a point $z$. The key point is that $z$ must in fact be on the line segment $\overline{ab}$; assuming that this was the case, we could obtain $z$ as a convex combination of $a$ and $b$, and $p$ as a convex combination of $v$ and $z$, and since $v$ is in $\overline{S^+}$ and $a,b\in S^+\subseteq\overline{S^+}$ we can conclude $p\in \overline{S^+}$.
%
    To show that $z\in \overline{ab}$, suppose not, so that $a$ lies between $z$ and $b$ (see \Cref{fig:triangulation2-b}). (The case where $z$ is on the $b$ side is similar.) We can decompose $z$ as a convex combination of some $w\in \overline{S\setminus\{a\}}$ and $a$, which means that $w,z,a,b$ are collinear and appear in this order on the line. Therefore $a$ is a convex combination of $w$ and $b$, which means that $a\in \overline{S\setminus\{a\}}$ which violates convexity of $S$.
\end{proof}

\noindent
By contraposition,
the triangulation lemma directly implies that
if $\{x \in S \mid \sigma(a,b,x) \neq +1\}$ and $\{x \in S \mid \sigma(a,b,x) \neq -1\}$
are both empty shapes in $P$,
then $S$ is an empty shape in $P$.

\subparagraph*{Running the CNF.}
Having now shown that our main result follows if $\phi_{30}$ is unsatisfiable,
we run a distributed computation to check its unsatisfiability.
We solve the SAT formula~$\phi_{30}$ produced by Lean using the same setup as
Heule and Scheucher~\cite{emptyHexagonNumber}, although using different hardware:
the Bridges 2 cluster of the Pittsburgh Supercomputing Center~\cite{cluster}.
Following Heule and Scheucher,
we partition the problem into 312\,418 subproblems.
Each of these subproblems was
solved using {\tt CaDiCaL} version 1.9.5.
The solver produced an LRAT proof for each execution,
which was validated using the {\tt cake\_lpr} verified checker on-the-fly
in order to avoid writing/storing/reading large files.
The total runtime was 25\,876.5 CPU hours, or roughly 3 CPU years.
The difference in runtime relative to Heule and Scheucher's original run
is purely due to the difference in hardware.
Additionally,
we validated that the subproblems cover the entire search space as Heule and Scheucher did~\cite[Section 7.3]{emptyHexagonNumber}.
This was done by verifying the unsatisfiability
of another formula that took 20 seconds to solve.

% file-local attic:

% By using the triangulation lemma repeatedly,
% we can slice up a convex $k$-gon into smaller pieces in any way we like until we get to triangles,
% thereby showing that convex polygons can be triangulated.
