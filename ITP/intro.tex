Mathematicians are skeptical of proofs relying on extensive computation.
However, there are many mathematically-interesting theorems that have been resolved by computation.
Some examples include the proofs of
Keller's conjecture~\cite{brakensiek2023resolution},
the packing chromatic number of the infinite grid~\cite{Subercaseaux_Heule_2023},
the Pythagorean triples problem~\cite{Heule_2016},
Lam's problem~\cite{21bright_sat_based_resolution_lams_problem},
and one case of the Erd\H{o}s discrepancy conjecture~\cite{konev2014sat}.

All of these proofs follow the same structure:
\begin{itemize}
  \item[(i)] Reduce the mathematical theorem to an instance~$P$ of the boolean satisfiability problem (SAT).
  \item[(ii)] Determine that $P$ has no satisfying truth assignment.\footnote{
    A variant of this procedure uses \emph{satisfying assignments} for $P$ to construct explicit witnesses for the original theorem, but we focus on the unsatisfiable case.}
\end{itemize}

Formal methods researchers have created methods and tools for ensuring the correctness of step (ii).
Modern SAT solvers produce proofs of unsatisfiability in a formal proof system,
such as DRAT~\cite{drat-trim14},
that can be checked with verified proof checkers,
such as \texttt{cake\_lpr}~\cite{tanVerifiedPropagationRedundancy2023}.
Yet in the literature, less scrutiny has been applied to the correctness of step (i),
leaving room for doubt that any results relying on such reduction arguments are correct.

A recent result from Heule and Scheucher~\cite{emptyHexagonNumber} falls into this category.
They resolve a variant of the Happy Ending Problem,
in particular that every set of 30 points in general position contains an empty convex hexagon.
Their proof relies on a complicated reduction to SAT
involving numerous nontrivial geometric optimizations and symmetry-breaking arguments.

In this paper, we prove their result in the Lean theorem prover~\cite{demouraLeanTheoremProver2015}
by connecting existing geometric definitions
in the \texttt{mathlib} mathematical proof library~\cite{The_mathlib_Community_2020}.
to the unsatisfiability of a particular SAT instance.
This sets a new standard for verifying results which rely on extensive computation.

Our formalization is publicly available at \url{https://github.com/bsubercaseaux/EmptyHexagonLean}.

\subparagraph*{The Empty Hexagon Number.}
In the 1930s,
following a suggestion of Esther Klein,
Erd\H{o}s and Szekeres showed that for any $k \geq 3$,
one can find a sufficiently large number $n$
such that every $n$ points in \emph{general position}
(i.e., with no three points collinear)
contain a convex \emph{$k$-gon}, i.e., a convex polygon with $k$ vertices~\cite{35erdos_combinatorial_problem_geometry}.
The minimal such $n$ is denoted $g(k)$.
The same authors later showed that $g(k) > 2^{k-2}$
and conjectured that this bound is tight~\cite{60erdos_some_extremum_problems_elementary_geometry}.
Indeed, it is known that $g(5) = 9$ and $g(6) = 17$,
with the latter result obtained by Szekeres and Peters 71 years after the initial conjecture
via exhaustive computer search~\cite{06szekeres_computer_solution_17_point_erdos_szekeres_problem}.
Larger cases remain open,
with $g(k) \leq 2^{k+o(k)}$ the best known upper bound~\cite{suk2017erdos,holmsen2017two}.
This problem is now known as the \emph{Happy Ending Problem},
as it led to the marriage of Klein and Szekeres.

In a similar spirit,
Erd\H{o}s defined $h(k)$
to be the minimal number of points in general position
that is guaranteed to contain a \emph{$k$-hole},
or \emph{empty $k$-gon},
meaning a convex $k$-gon with no other point inside.
It is easy to check that $h(3) = 3$ and $h(4) = 5$.
In 1978, Harborth established that $h(5) = 10$~\cite{Harborth1978}.
Surprisingly, for $k \geq 7$ a point set with no $k$-hole
can always be constructed
as demonstrated by Horton in 1983~\cite{hortonSetsNoEmpty1983}.
The only case left open was thus $h(6)$.
The \emph{Empty Hexagon Theorem},
establishing $h(6)$ to be finite,
was proven independently by Gerken and Nicolás in 2006~\cite{gerkenEmptyConvexHexagons2008,nicolasEmptyHexagonTheorem2007}.
As of last year,
the known range of values for $h(6)$ was quite large,
at $30 \leq h(6) \leq 1717$
as refined by Valtr in 2008~\cite{valtr},
until a breakthrough by Heule and Scheucher~\cite{emptyHexagonNumber}.
These authors used a SAT solver
to prove that $h(6) \leq 30$,
a result we refer to as the \emph{Empty Hexagon Number}.
Now that all the values of $h$ are known,
and especially given the extensive computation involved in its proofs,
we propose that the final chapter in the story
should be a formal verification of the Empty Hexagon Number.

\subparagraph*{Verification of SAT proofs.}
Formal verification plays a crucial role in the SAT community,
for example in verified solvers~\cite{10maric_formal_verification_modern_sat_solver_shallow_embedding_isabelle_hol,oeVersatVerifiedModern2012,skotam_creusat_2022}
and proof checking~\cite{lammichEfficientVerifiedSAT2020,tanVerifiedPropagationRedundancy2023}.
Despite this,
not many mathematical proofs obtained through SAT-solving
have been formally verified.

In SAT-based combinatorial geometry,
formal verification was pioneered by Marić~\cite{19maric_fast_formal_proof_erdos_szekeres_conjecture_convex_polygons_most_six_points}
who improved on the speed needed to obtain $g(6) = 17$,
and trustworthiness of this result,
by replacing bespoke code with a SAT encoding
and verifying this encoding in \textsf{Isabelle/HOL}.
We give a detailed comparison between this work and ours in~\Cref{sec:related-work}.
The solution to the Pythagorean triples problem
was verified in the \textsf{Coq} proof assistant
by Cruz-Filipe and coauthors~\cite{formalPythagoreanTriples,LPAR-21:Formally_Proving_Boolean_Pythagorean}.
Giljeg\r{a}rd and Wennerbreck~\cite{GilAndWennerbeck} provide a \textsf{CakeML} library
for verified SAT encodings
which they demonstrated on different puzzles
(e.g., Sudoku, Kakuro, the \emph{N-queens} problem).
As far as verifying SAT encodings in Lean,
we base our work on that of Codel, Avigad, and Heule~\cite{Cayden}.

\subparagraph*{Lean.}
Initially developed by Leonardo de Moura in 2013~\cite{demouraLeanTheoremProver2015}, the Lean theorem prover has arguably become the most popular theorem prover for formalizing modern breakthroughs in mathematical research.
On the one hand, the recent success of projects such as the~\emph{Liquid Tensor Experiment}~\cite{Castelvecchi2021}, or the proof of~the polynomial Freiman–Ruzsa conjecture~\cite{gowers2023conjecture, slomanATeamMathProves2023} has brought significant attention to~Lean. % as an interactive theorem prover.
On the the other hand, the \textsf{mathlib} project~\cite{The_mathlib_Community_2020} has already cemented the foundations of many areas of mathematics, thus allowing modern results to be formalized much more easily by relying on hundreds of thousands of existing lines of code. In this spirit, we connect our formalization to~\textsf{mathlib} as much as possible.

\subparagraph*{Mathlib.}
% TODO

\subparagraph*{Outline of the paper.}
\Cref{sec:geometry} discusses the basic geometric aspects of the problem.  Then,~\Cref{sec:triple-orientations} is devoted to \emph{triple orientations}, a fundamental tool in computational geometry to discretely represent problems involving an a priori continuous space (i.e., $\mathbb{R}^2$).
 Triple orientations are the basis of Heule and Scheucher's SAT encoding.
 Next,~\Cref{sec:properties-of-sigma} proves properties of orientations that reduce the search space,
and correspond to~\Cref{eq:signotopeClauses11,eq:signotopeClauses12}.
% Then,~\Cref{sec:empty-triangle} presents how the previous elements are already enough to formalize a SAT-based proof for the \emph{Empty Triangle Theorem}, a much simpler problem involving only triangles.
The Empty Hexagon Number requires a sophisticated encoding, presented in~\Cref{fig:full-encoding}, for which two main ingredients are required. First,~\Cref{sec:symmetry-breaking} deals with symmetry breaking, proving that one can assume, without loss of generality, that points are in \emph{canonical position}, a definition that includes points being simultaneously sorted from left-to-right and by angle with respect to the leftmost point.
%  Namely, that one can assume without loss of generality the following two properties at the same time: (i) points are labeled from left to right without two of them having the same $x$-coordinate, and (ii) the triples $(p_1, p_i, p_j)$ are always oriented counterclockwise for $i < j$.
Then,~\Cref{sec:empty-hexagon-number} deals with the efficient re-encoding of Heule and Scheucher, the crucial piece to make the proof of $h(6) = 30$ feasible. Next,~\Cref{sec:leansat} presents the preliminary \textsf{LeanSAT} library, which is used to create a SAT encoding that is provably connected to the geometric properties it describes. We compare our work with its closest precedent due to Marić~\cite{19maric_fast_formal_proof_erdos_szekeres_conjecture_convex_polygons_most_six_points} in~\Cref{sec:related-work}. We conclude in~\Cref{sec:conclusions} by discussing next steps towards the formal verification of other Erd\H{o}s-Szekeres-type problems.

\begin{figure}
  \caption{Encoding based on that of Heule and Scheucher for the Empty Hexagon Number~\cite{emptyHexagonNumber}. Unsatisfiability of the formula below for $n=30$ implies $h(6) \leq 30$, as detailed throughout the paper. }
  \label{fig:full-encoding}
% \begin{framed}
  \begin{spreadlines}{16pt}
\begin{gather}
\hfsetfillcolor{green!10}
\hfsetbordercolor{green!60!black}
\tikzmarkin{b}(12.0,-0.9)(-0.5,0.5)
  \cvar_{i; a,b, c} \rightarrow \left(\left(\orvar_{a,b,c} \leftrightarrow \orvar_{a, i, c}  \right) \land \left(\orvar_{a,b,c} \leftrightarrow \ov{\orvar_{a, i, b}}  \right)\right) \text{ for all } 2 \leq a < i < b < c \leq n\label{eq:insideClauses1}\\
  \cvar_{i; a,b, c} \rightarrow \left(\left(\orvar_{a,b,c} \leftrightarrow \orvar_{a, i, c}  \right) \land \left(\orvar_{a,b,c} \leftrightarrow \ov{\orvar_{b, i, c}}  \right)\right) \text{ for all } 2 \leq a < b < i < c \leq n\label{eq:insideClauses2}\\
  \tikzmarkend{b}\Big(\bigwedge_{\substack{a < i < c\\ i \neq b}} \ov{\cvar_{i; a,b,c}}\Big) \rightarrow \hvar_{a, b, c} \quad \text{ for all } 2 \leq a < b < c \leq n\label{eq:holeDefClauses1}\\
%
\tikzmarkin{a}(12.0,-0.3)(-0.5,0.5)
  \orvar_{a, b, c} \land \orvar_{a, c, d} \rightarrow \orvar_{a, b, d} \quad \text{ for all } 2 \leq a < b < c < d \leq n\label{eq:signotopeClauses11}\\
  \tikzmarkend{a}\ov{\orvar_{a, b, c}} \land \ov{\orvar_{a, c, d}} \rightarrow \ov{\orvar_{a, b, d}} \quad \text{ for all } 2 \leq a < b < c < d \leq n \label{eq:signotopeClauses12}\\
%
\hfsetfillcolor{blue!10}
\hfsetbordercolor{blue!60!black}
\tikzmarkin{c}(12.0,-0.4)(-0.5,0.6)
  % \orvar_{1, b, c} \quad \text{ for all } 2 \leq b < c \leq n \label{eq:revLexClauses}\\
  \tikzmarkend{c}\left(\orvar_{\lceil \frac{n}{2} \rceil -1, \lceil \frac{n}{2} \rceil,\lceil \frac{n}{2} \rceil+1}, \ldots, \orvar_{2,3,4} \right) \succeq_{\text{lex}} \left(\orvar_{\lfloor \frac{n}{2}\rfloor +1,  \lfloor \frac{n}{2}\rfloor +2, \lfloor \frac{n}{2}\rfloor +3}, \ldots, \orvar_{n-2, n-1, n} \right)\label{eq:revLexClauses}\\
%
\hfsetfillcolor{orange!10}
\hfsetbordercolor{orange!60!black}
\tikzmarkin{d}(12.0,-0.3)(-0.5,0.5)
  \ov{\orvar_{a,b,c}} \land \ov{\orvar_{b,c,d}} \rightarrow \uvar_{a, c, d} \quad \text{ for all } 2 \leq a < b < c < d \leq n\label{eq:capDef}\\
  \orvar_{a, b, c} \land \orvar_{b, c, d} \rightarrow \vvar_{a, c, d} \quad \text{ for all } 2 \leq a < b < c < d \leq n \label{eq:cupDef}\\
  \uvar_{a,b,c} \land \ov{\orvar_{b,c,d}} \land \hvar_{a,b,d} \rightarrow \ufvar_{a, c, d} \quad \text{ for all } 2 \leq a < b < c < d \leq n,\; a+1<b\label{eq:capFDef}\\
  \uvar_{a, c, d} \rightarrow \ov{\orvar_{a,c,d}} \quad \text{ for all } 2 \leq a < c < d \leq n,\ a+1<c\label{eq:capDef2}\\
  \tikzmarkend{d}\vvar_{a, c, d} \rightarrow \orvar_{a,c,d} \quad \text{ for all } 2 \leq a < c < d \leq n,\; a+1<c\label{eq:cupDef2}\\
%
\hfsetfillcolor{red!10}
\hfsetbordercolor{red!60!black}
\tikzmarkin{e}(12.0,-0.5)(-0.5,0.5)
  \neg(\ufvar_{a,d,e} \land \orvar_{a, b, e}) \quad \text { for all } 2 \leq a < d < e \leq n, \; a < b < e, \; a+2 < d\label{eq:no6Hole1Below}\\
  \neg(\ufvar_{a,d,e} \land \ov{\orvar_{d, e, f}}) \quad \text { for all } 2 \leq a < d < e < f\leq n, \; a+2 < d\label{eq:no6Hole4Above}\\
  \neg(\uvar_{a,c,d} \land \vvar_{a, c', d} \land \hvar_{a,c,c'}) \quad \text{ for all } 2 \leq a < c < c' < d \leq n, \; a+1 < c\label{eq:no6Hole2Below1}\\
  \neg(\uvar_{a,c,d} \land \vvar_{a, c', d} \land \hvar_{a,c',c}) \quad \text{ for all } 2 \leq a < c' < c < d \leq n, \; a+1 < c'\label{eq:no6Hole2Below2}\\
  \tikzmarkend{e}\neg(\vvar_{a,c,d} \land \orvar_{c, d, e} \land \hvar_{a,c,e}) \quad \text{ for all } 2 \leq a < c < d < e \leq n, \; a+1 < c\label{eq:no6Hole3Below}
  \end{gather}
\end{spreadlines}
% \end{framed}
\end{figure}

